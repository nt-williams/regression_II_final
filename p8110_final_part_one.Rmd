---
title: "Applied Regression II Final - Part One"
author: "Nick Williams"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(kableExtra)
```

*Data import and preparation*

```{}
proc import out = depression 
  datafile = "~\final\regression_II_final\data.csv"
	dbms = csv replace; 
	getnames = yes; 
run; 

data depression; 
	set depression; 
	rename PARDEP = parent_dep
		   DSMDEPHR = child_dep
		   PTSEX = child_sex
		   PTAGE = child_age
		   BEDEPON = age_child_dep
		   DSMSUBHR = sub_abuse_child
		   BESUBON = age_sub_child
		   SESCLASS = ses_parent
		   MSPARENT = mar_stat_parent; 
run;
```

1. I defined the start time as the time of birth for all children. The end time was defined as either the age of onset of depression in children that were classified as ever having depression or as the age of a child at the interview for children that classified as never having depression. To hold this survival time, I created a variable called `follow_time`:

```{}
data depression;
	set depression; 

	if child_dep = 1 then 
		follow_time = age_child_dep; 
	else if child_dep = 0 
		then follow_time = child_age; 
run; 
```

2. 

```{}
proc means data = depression median clm maxdec = 2; 
	var age_child_dep;
	class parent_dep; 
	where child_dep = 1;
run;
```

3. 

```{r echo = FALSE, message = FALSE, warning = FALSE}
depress <- read_csv("./data/data.csv") %>% 
  janitor::clean_names()

sex_tbl <- depress %>% 
  mutate(pardep = as.factor(pardep), 
         pardep = fct_recode(pardep, "Ever depressed" = "1", "Never depressed" = "0"),
         ptsex = as.factor(ptsex), 
         ptsex = fct_recode(ptsex, Male = "1", Female = "2")) %>% 
  group_by(pardep, ptsex) %>% 
  summarize(n = n()) %>% 
  mutate(freq = round(((n / sum(n)) * 100), 2)) %>%
  unite("n_freq", c(n, freq), sep = " ") %>% 
  spread(key = pardep, value = n_freq) %>% 
  rename("Covariate" = ptsex) 

depress_tbl <- depress %>% 
  mutate(pardep = as.factor(pardep), 
         pardep = fct_recode(pardep, "Ever depressed" = "1", "Never depressed" = "0"),
         dsmdephr = as.factor(dsmdephr), 
         dsmdephr = fct_recode(dsmdephr, "Ever depressed" = "1", "Never depressed" = "0")) %>% 
  group_by(pardep, dsmdephr) %>% 
  summarize(n = n()) %>% 
  mutate(freq = round(((n / sum(n)) * 100), 2)) %>% 
  unite("n_freq", c(n, freq), sep = " ") %>% 
  spread(key = pardep, value = n_freq) %>% 
  rename("Covariate" = dsmdephr)

sub_abuse_tbl <- depress %>% 
  mutate(pardep = as.factor(pardep), 
         pardep = fct_recode(pardep, "Ever depressed" = "1", "Never depressed" = "0"),
         dsmsubhr = as.factor(dsmsubhr), 
         dsmsubhr = fct_recode(dsmsubhr, "Substance abuse" = "1", "No substance abuse" = "0")) %>% 
  group_by(pardep, dsmsubhr) %>% 
  summarize(n = n()) %>% 
  mutate(freq = round(((n / sum(n)) * 100), 2)) %>% 
  unite("n_freq", c(n, freq), sep = " ") %>% 
  spread(key = pardep, value = n_freq) %>% 
  rename("Covariate" = dsmsubhr)

ses_tbl <- depress %>% 
  mutate(pardep = as.factor(pardep), 
         pardep = fct_recode(pardep, "Ever depressed" = "1", "Never depressed" = "0"), 
         sesclass = as.factor(sesclass)) %>%
  filter(!is.na(sesclass)) %>% 
  group_by(pardep, sesclass) %>% 
  summarize(n = n()) %>% 
  mutate(freq = round(((n / sum(n)) * 100), 2)) %>% 
  unite("n_freq", c(n, freq), sep = " ") %>% 
  spread(key = pardep, value = n_freq) %>% 
  rename("Covariate" = sesclass)

marital_tbl <- depress %>% 
  mutate(pardep = as.factor(pardep), 
         pardep = fct_recode(pardep, "Ever depressed" = "1", "Never depressed" = "0"),
         msparent = as.factor(msparent), 
         msparent = fct_recode(msparent, "Married w/Spouse" = "1", "Separated/Divorced" = "2")) %>%
  group_by(pardep, msparent) %>% 
  summarize(n = n()) %>% 
  mutate(freq = round(((n / sum(n)) * 100), 2)) %>%
  unite("n_freq", c(n, freq), sep = " ") %>% 
  spread(key = pardep, value = n_freq) %>% 
  rename("Covariate" = msparent)
```

```{r echo = FALSE, warning = FALSE}
bind_rows(sex_tbl, depress_tbl, sub_abuse_tbl, ses_tbl, marital_tbl) %>% 
  mutate_all(linebreak) %>% 
  kable("latex", 
        caption = "Offspring characteristics stratified by parental depression status", 
        booktabs = TRUE, 
        escape = FALSE,
        col.names = linebreak(c("Covariate", "Never depressed\n(N = 95)", "Ever depressed\n(N = 125)")
                              , align = "c"),
        align = c("c", rep('r', 1))) %>% 
  add_header_above(c(" ", "Parent depression status" = 2)) %>%
    kable_styling() %>% 
    group_rows("Child sex", 1, 2) %>% 
    group_rows("Child depression status", 3, 4) %>% 
    group_rows("Child substance abuse", 5, 6) %>% 
    group_rows("Parent SES class", 7, 11) %>% 
    group_rows("Parent marital status", 12, 13)
```


4. 

```{}
proc lifetest data = depression method = km conftype = loglog stderr plots = survival(cl);
	strata parent_dep;  
	time follow_time * child_dep(0); 
run; 
```

  (i) $H_0: S_1(t) = S_2(t) \text{ for all } t \leq \tau$  
      $H_A: S_1(t) \neq S_2(t) \text{ for some } t \leq \tau$
  (ii) $Q = 7.6876 \sim \chi^2_1$  
       $p = P(\chi^2_1 \geq 7.6876) = 0.0056$
  (iii) $0.0056 < 0.05 \rightarrow$ reject the null hypothesis
  (iv) At the 5% signficance level, there is sufficient evidence to claim that age of onset of depression in children differs between children with parental history of depression and children without parental history of depression. 


