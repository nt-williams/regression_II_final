---
title: "Applied Regression II Final - Part Two"
author: "Nick Williams"
output: 
  pdf_document:
    fig_caption: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")

library(tidyverse)
library(kableExtra)
```

```{r making dataframe for tables, echo = FALSE}

cox_tbl_1 <- tibble(
  Covariate = c("Parental Depression", "No Parental Depression"), 
  "HR (95% CI)" = c("2.01 (1.21, 3.33)", "1.00 (reference)"), 
  "p-Value" = c(0.007, "")
)

cox_tbl_2 <- tibble(
  Covariate = c("No parental depression, pre-pubertal onset", "Parental depression, pre-pubertal onset", "No parental depression, not pre-pubertal onset", "Parental depression, not pre-pubertal onset"), 
  "HR (95% CI)" = c("1.00 (reference)" ,"5.16 (1.53, 17.42)", "1.00 (reference)", "1.32 (0.73, 2.38)"), 
  "p-Value" = c("", "", "", "")
)
```

Model summaries for both model one and model two are found in the summary section. 

*Model One*

Model one uses a Cox model to model the time until a child experiences depression as a function of parental history of depression:

$$
\begin{aligned}
  h(t, x) &= h_0(t)h(\beta_1x_{1i}) \\
  \text{where, } x_1 &= 
    \begin{cases}
    0 \text{ if no history of parental depression} \\
    1 \text{ if history of parental depression }
    \end{cases}
\end{aligned}
$$

SAS code for the model is as follows: 

```{}
proc phreg data = depression;
	class parent_dep (ref = '0') / param = ref;
	model follow_time * child_dep(0) = parent_dep / ties = efron risklimits; 
	assess ph / resample; 
run; 
```

I tested the proportional hazards assumption for parental depression and found that it was violated (p = 0.003). Because the proportional hazards assumption is violated, parental depression is a time-dependent and this needs to be controlled for.

```{r echo = FALSE, fig.align = "center", out.width = "300px"}
knitr::include_graphics("./reports/ph_plot.png")
```

*Model Two*

A check of the proportional hazards assumption in model one showed that the effect of parental history on the time until a child experiences depression is not constant over time. As such, in model 2 I have introduced a time-dependent covariate ("early_onset") that indicates if the age that depression started or the age at which censoring occured were pre-pubertal (< 13 years old) or not (13 years or older): 

$$
\begin{aligned}
  h(t, x) &= h_0(t)h(\beta_1x_{1i} + \beta_2x_{2i} + \beta_3x_{1i}x_{2i}) \\
  \text{where, } x_1 &= 
    \begin{cases}
    0 \text{ if no history of parental depression} \\
    1 \text{ if history of parental depression }
    \end{cases} \\ x_2 &= 
    \begin{cases}
    0 \text{ if follow time is} \geq \text{ 13 years} \\
    1 \text{ if follow time is} < \text{ 13 years}
    \end{cases}
\end{aligned}
$$

SAS code for model two is as follows:

```{}
data depression; 
	set depression; 
	if follow_time >= 13 then early_onset = 0; 
		else early_onset = 1; 
run; 

proc phreg data = depression; 
	class parent_dep (ref = '0') / param = ref;
	class early_onset (ref = '0') / param = ref;
	model follow_time * child_dep(0) = parent_dep early_onset parent_dep*early_onset / ties = efron;
	hazardratio parent_dep / diff = ref;
run; 
```

*Summary*

Table 1 provides hazard ratios and corresponding 95% confidence intervals for model one and model two. 

```{r model table, echo = FALSE}
bind_rows(cox_tbl_1, cox_tbl_2) %>%
  kable("latex", 
        caption = "Hazard ratios comparing risk of depression according to parental depression history",
        booktabs = TRUE) %>% 
  kable_styling(latex_options = "hold_position") %>% 
  group_rows("Model 1: Parental depression status only", 1, 2) %>% 
  group_rows("Model 2: Pre-pubertal onset interaction", 3, 6)
```

